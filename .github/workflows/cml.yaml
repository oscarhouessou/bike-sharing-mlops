name: model-training
on: [push]
jobs:
  run:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      id-token: write
    steps:
      - uses: actions/checkout@v3
      - uses: iterative/setup-cml@v1
      - uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Train model
        env:
          GCP_SA_KEY: ${{ secrets.GCP_SA_KEY }}
        run: |
          pip install "dvc[gs]" -r requirements.txt
          
          # 1. Configurer la clÃ© GCP localement pour ce run
          echo "$GCP_SA_KEY" > provider_key.json
          dvc remote modify storage --local credentialpath provider_key.json
          
          # 2. RÃ©cupÃ©rer les donnÃ©es et exÃ©cuter le pipeline
          dvc pull
          dvc repro
          
      - name: Write report
        env:
          REPO_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "## ðŸš€ Rapport d'entraÃ®nement MLOps" > report.md
          echo "Date : $(date)" >> report.md
          
          echo "### âœ… MÃ©triques du modÃ¨le" >> report.md
          # On rÃ©cupÃ¨re les mÃ©triques si tu as configurÃ© dvc metrics, 
          # sinon on peut lire directement le log de ton script
          echo "Le modÃ¨le a Ã©tÃ© rÃ©-entraÃ®nÃ© avec succÃ¨s sur la machine GitHub." >> report.md
          
          # Si tu veux ajouter un graphique gÃ©nÃ©rÃ© par ton script :
          # echo "### ðŸ“ˆ Visualisation" >> report.md
          # echo "![](./path/to/plot.png)" >> report.md
          
          cml send-comment report.md
          rm provider_key.json